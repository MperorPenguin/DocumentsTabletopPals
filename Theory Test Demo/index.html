<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>UK Theory Prep — DVSA-style (Original)</title>
<style>
:root{
  /* Palette */
  --amber:#FFB15C;
  --green:#469B72;
  --ink:#1D152D;
  --offwhite:#F0EEEF;
  --rose:#F0C9CE;

  --bg: var(--offwhite);
  --fg: var(--ink);
  --muted:#6e6a86;
  --card:#fff;

  --radius: 16px;
  --shadow: 0 6px 18px rgba(0,0,0,.08);
  --ring: 0 0 0 3px color-mix(in oklab, var(--rose) 35%, transparent);
  --fast:160ms;
  --ease:cubic-bezier(.2,.8,.2,1);
}
@media (prefers-color-scheme:dark){
  :root{ --bg:#15121C; --fg:#EAE6F2; --card:#1E1A27; --muted:#A39FB3; --shadow:0 8px 22px rgba(0,0,0,.35); }
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0; color:var(--fg); background:
  radial-gradient(60% 60% at 110% -10%, color-mix(in oklab,var(--rose)20%,transparent), transparent),
  radial-gradient(60% 60% at -10% 110%, color-mix(in oklab,var(--green)18%,transparent), transparent),
  var(--bg);
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
}
.container{ width:min(1100px,96vw); margin-inline:auto; padding:clamp(12px,2vw,24px); }
.header{ position:sticky; top:0; z-index:40; backdrop-filter:blur(8px);
  background: color-mix(in oklab, var(--bg) 82%, transparent);
  border-bottom:1px solid color-mix(in oklab,var(--fg)12%,transparent);
}
.header .bar{ display:flex; align-items:center; justify-content:space-between; gap:16px; padding-block:10px; }
.brand{ display:flex; align-items:center; gap:12px; color:var(--fg); text-decoration:none; font-weight:800 }
.logo{ width:36px; height:36px; border-radius:12px; box-shadow:var(--shadow);
  background: conic-gradient(from 220deg, var(--ink), var(--green), var(--rose), var(--amber), var(--ink)); }
nav a{
  color:var(--fg); text-decoration:none; font-weight:600; padding:10px 14px; border-radius:12px;
  transition:transform var(--fast) var(--ease), background var(--fast);
}
nav a[aria-current="page"]{ background:color-mix(in oklab, var(--fg)6%, transparent); }
nav a:hover{ transform:translateY(-1px); background:color-mix(in oklab,var(--rose)18%,transparent); }
nav a:focus-visible{ outline:none; box-shadow:var(--ring); }

main{ padding-block:clamp(12px, 3vw, 28px); }
.card{ background:var(--card); border-radius:20px; box-shadow:var(--shadow); padding:clamp(14px,2vw,20px); }
.grid{ display:grid; gap:clamp(12px,2.4vw,24px) }
.grid.cols-2{ grid-template-columns:1.1fr .9fr }
.grid.cols-3{ grid-template-columns:repeat(3,1fr) }
@media (max-width:920px){ .grid.cols-2{ grid-template-columns:1fr } .grid.cols-3{ grid-template-columns:1fr 1fr } }
@media (max-width:640px){ .grid.cols-3{ grid-template-columns:1fr } }

h1{ font-size:clamp(1.8rem,3.8vw,3rem); margin:.2rem 0 .6rem }
.lead{ color:var(--muted); font-size:clamp(1rem,1.6vw,1.2rem) }
.row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
.space-between{ justify-content:space-between }
.small{ font-size:.92rem } .muted{ color:var(--muted) }
.badge{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:color-mix(in oklab,var(--green)22%,transparent); font-weight:700 }

.btn{
  appearance:none; border:0; cursor:pointer; padding:12px 18px; border-radius:14px; font-weight:800;
  color:white; background:var(--ink); box-shadow:var(--shadow);
  transition:transform var(--fast) var(--ease), opacity var(--fast), box-shadow var(--fast);
}
.btn:hover{ transform:translateY(-1px); opacity:.95 }
.btn:active{ transform:translateY(0) scale(.99) }
.btn:focus-visible{ outline:none; box-shadow:var(--ring); }
.btn.ghost{ background:color-mix(in oklab,var(--ink)12%,transparent); color:var(--fg) }
.btn.accent{ background:linear-gradient(135deg,var(--green),var(--ink)) }
.btn.warn{ background:var(--amber); color:#3b2c00 }

.progress{ width:100%; height:10px; border-radius:999px; background:color-mix(in oklab,var(--fg)9%,transparent); overflow:hidden }
.progress>i{ display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--green), var(--amber)); transition:width 280ms var(--ease) }

fieldset{ border:0; padding:0; margin:0 } legend{ font-weight:800; margin-bottom:10px }
.options{ display:grid; gap:10px }
.option{ display:flex; gap:12px; align-items:flex-start; background:color-mix(in oklab,var(--fg)6%,transparent); border-radius:14px; padding:12px; transition:background var(--fast), transform var(--fast) }
.option:hover{ background:color-mix(in oklab,var(--rose)16%,transparent); transform:translateY(-1px) }
.option input{ width:22px; height:22px; margin-top:2px }

.media{ aspect-ratio:16/9; border-radius:18px; background:color-mix(in oklab,var(--fg)6%,transparent); display:grid; place-items:center; overflow:hidden; margin:8px 0 14px }
.media svg{ width:100%; height:100% }

.reveal{ animation:reveal .6s var(--ease) both } @keyframes reveal{ from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none} }

.footer{ margin:36px auto 28px; color:var(--muted); font-size:.95rem }
.hidden{ display:none !important }
hr{ border:none; height:1px; background:color-mix(in oklab, var(--fg)10%, transparent); margin:10px 0 14px }
input[type="text"], select{ padding:12px; border-radius:12px; border:1px solid color-mix(in oklab,var(--fg)14%,transparent); background:var(--card); color:var(--fg) }
</style>
</head>
<body>
<header class="header">
  <div class="container bar">
    <a class="brand" href="#" data-nav="home"><i class="logo" aria-hidden="true"></i> UK Theory Prep</a>
    <nav>
      <a href="#" data-nav="home"   aria-current="page">Home</a>
      <a href="#" data-nav="mock">Mock Test</a>
      <a href="#" data-nav="revision">Revision</a>
      <a href="#" data-nav="signs">Signs & Images</a>
    </nav>
  </div>
</header>

<main class="container">
  <!-- HOME -->
  <section id="view-home" class="reveal">
    <div class="grid cols-2">
      <div class="card">
        <h1>Practice the UK Car Theory Test</h1>
        <p class="lead">50 DVSA-style questions, a 57-minute timer, original sign diagrams, and targeted revision — all in your palette.</p>
        <div class="row" style="margin-top:10px">
          <button class="btn accent" data-nav="mock">Begin Mock Test</button>
          <button class="btn ghost" data-nav="revision">Targeted Revision</button>
        </div>
        <div class="row" style="margin-top:12px">
          <span class="badge"><b id="lastScore">No attempts yet</b></span>
          <span class="small muted">Pass mark: 43/50 · Time: 57 minutes</span>
        </div>
      </div>
      <div class="card">
        <h3>Quick actions</h3>
        <div class="row">
          <button class="btn" id="btnReset">Reset Progress</button>
        </div>
        <hr>
        <p class="small muted">Progress is stored <b>locally</b> in your browser (no cookies, no tracking).</p>
      </div>
    </div>
  </section>

  <!-- MOCK TEST -->
  <section id="view-mock" class="reveal hidden">
    <div class="card">
      <div class="row space-between">
        <div class="row"><span class="badge">Question <b id="qIndex">1</b>/<b id="qTotal">50</b></span></div>
        <div class="row small muted" role="timer" aria-live="polite">Time left: <b id="timer">57:00</b></div>
      </div>
      <div class="progress" aria-hidden="true"><i id="bar"></i></div>
      <div class="media" id="mediaBox" aria-label="Question image"></div>
      <form id="qForm">
        <fieldset>
          <legend id="qText">Loading question…</legend>
          <div class="options" id="options"></div>
        </fieldset>
      </form>
      <div class="row space-between" style="margin-top:10px">
        <button class="btn ghost" id="btnFlag" type="button" title="Mark for review">★ Flag</button>
        <div class="row">
          <button class="btn ghost" id="btnPrev" type="button">Previous</button>
          <button class="btn" id="btnNext" type="button">Next</button>
          <button class="btn accent hidden" id="btnFinish" type="button">Finish</button>
        </div>
      </div>
    </div>
    <section id="summary" class="card hidden"></section>
  </section>

  <!-- REVISION -->
  <section id="view-revision" class="reveal hidden">
    <div class="card">
      <h2>Targeted Revision</h2>
      <p class="muted">Build a quick drill from your weakest topics or pick random practice.</p>
      <div class="row">
        <button class="btn" id="btnWeak">10 from my weak topics</button>
        <button class="btn ghost" id="btnAll">10 random</button>
      </div>
    </div>
    <div id="revRoot" class="grid"></div>
  </section>

  <!-- SIGNS -->
  <section id="view-signs" class="reveal hidden">
    <div class="card">
      <h2>Signs & Scenes Gallery</h2>
      <p class="muted">All SVGs are original and royalty-free. Search or filter below.</p>
      <div class="row">
        <input id="search" placeholder="Search e.g. ‘roundabout’, ‘give way’" style="flex:1">
        <select id="filter">
          <option value="all">All</option>
          <option value="warning">Warning</option>
          <option value="regulatory">Regulatory</option>
          <option value="informational">Informational</option>
          <option value="scene">Road Scenes</option>
        </select>
      </div>
    </div>
    <div id="signGrid" class="grid cols-3" style="margin-top:12px"></div>
  </section>
</main>

<footer class="container footer">
  <p class="small">Practice resource. <b>Not affiliated with DVSA.</b> Questions and SVGs are original DVSA-style content. For official practice, see GOV.UK.</p>
</footer>

<!-- ----------- Inline SVG Symbols (original) ----------- -->
<svg width="0" height="0" style="position:absolute; left:-9999px; visibility:hidden" aria-hidden="true">
  <!-- 30 mph -->
  <symbol id="sgn-speed30" viewBox="0 0 200 200">
    <circle cx="100" cy="100" r="96" fill="#fff" stroke="#E2E2E6" stroke-width="2"/>
    <circle cx="100" cy="100" r="86" fill="none" stroke="#E44" stroke-width="18"/>
    <text x="100" y="122" font-family="Inter, Arial, sans-serif" font-size="84" font-weight="800" text-anchor="middle" fill="#1D152D">30</text>
  </symbol>
  <!-- No entry -->
  <symbol id="sgn-noentry" viewBox="0 0 200 200">
    <circle cx="100" cy="100" r="96" fill="#fff" stroke="#E2E2E6" stroke-width="2"/>
    <circle cx="100" cy="100" r="86" fill="#E44"/>
    <rect x="45" y="88" width="110" height="24" fill="#fff" rx="4"/>
  </symbol>
  <!-- Give way -->
  <symbol id="sgn-giveway" viewBox="0 0 220 190">
    <polygon points="110,10 210,180 10,180" fill="#fff" stroke="#E2E2E6" stroke-width="2"/>
    <polygon points="110,22 196,172 24,172" fill="none" stroke="#E44" stroke-width="18"/>
    <polygon points="110,44 182,164 38,164" fill="#fff"/>
  </symbol>
  <!-- Works (warning) -->
  <symbol id="sgn-works" viewBox="0 0 220 190">
    <polygon points="110,10 210,180 10,180" fill="#fff" stroke="#E2E2E6" stroke-width="2"/>
    <polygon points="110,22 196,172 24,172" fill="none" stroke="#E44" stroke-width="18"/>
    <g transform="translate(0,0)" fill="#1D152D">
      <path d="M60 150h100v10H60z"/>
      <circle cx="120" cy="120" r="10"/>
      <path d="M80 135l30-30 15 15 15-5 10 20" stroke="#1D152D" stroke-width="8" fill="none"/>
    </g>
  </symbol>
  <!-- Roundabout -->
  <symbol id="sgn-roundabout" viewBox="0 0 200 200">
    <circle cx="100" cy="100" r="96" fill="#fff" stroke="#E2E2E6" stroke-width="2"/>
    <circle cx="100" cy="100" r="86" fill="#fff" stroke="#1D152D" stroke-width="14"/>
    <g transform="translate(100,100)" fill="#1D152D">
      <path d="M0-56 a56 56 0 0 1 56 56 h-14 a42 42 0 0 0-42-42z"/>
      <path d="M56 0 a56 56 0 0 1-56 56 v-14 a42 42 0 0 0 42-42z"/>
      <path d="M0 56 A56 56 0 0 1 -56 0 h14 a42 42 0 0 0 42 42z"/>
    </g>
  </symbol>
  <!-- Motorway info -->
  <symbol id="sgn-motorway" viewBox="0 0 260 160">
    <rect x="3" y="3" width="254" height="154" rx="16" fill="#2B6CB0" stroke="#E2E2E6" stroke-width="2"/>
    <g stroke="#fff" stroke-width="10" fill="none" stroke-linecap="round">
      <path d="M90 140 V30"/>
      <path d="M170 140 V30"/>
      <path d="M90 30 L120 10"/>
      <path d="M170 30 L140 10"/>
    </g>
  </symbol>
  <!-- Horse warning -->
  <symbol id="sgn-horse" viewBox="0 0 220 190">
    <polygon points="110,10 210,180 10,180" fill="#fff" stroke="#E2E2E6" stroke-width="2"/>
    <polygon points="110,22 196,172 24,172" fill="none" stroke="#E44" stroke-width="18"/>
    <g transform="translate(45,80)" fill="#1D152D">
      <circle cx="90" cy="30" r="10"/>
      <rect x="10" y="48" width="130" height="12"/>
      <path d="M15 50c5-25 25-40 45-40h40c20 0 35 15 40 40" stroke="#1D152D" stroke-width="8" fill="none"/>
    </g>
  </symbol>

  <!-- Scenes (stylised diagrams) -->
  <symbol id="scene-zebra" viewBox="0 0 400 225">
    <defs>
      <linearGradient id="sky1" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0" stop-color="#F0C9CE"/><stop offset="1" stop-color="#F0EEEF"/>
      </linearGradient>
    </defs>
    <rect width="400" height="225" fill="url(#sky1)"/>
    <rect y="120" width="400" height="105" fill="#2F2A3B"/>
    <g fill="#fff">
      <rect x="40" y="140" width="40" height="16" rx="3"/>
      <rect x="100" y="140" width="40" height="16" rx="3"/>
      <rect x="160" y="140" width="40" height="16" rx="3"/>
      <rect x="220" y="140" width="40" height="16" rx="3"/>
      <rect x="280" y="140" width="40" height="16" rx="3"/>
      <rect x="340" y="140" width="20" height="16" rx="3"/>
    </g>
    <rect y="130" width="400" height="6" fill="#8883"/>
    <rect y="158" width="400" height="6" fill="#8883"/>
    <g transform="translate(20,110)" fill="#1D152D">
      <circle cx="20" cy="10" r="8"/><rect x="15" y="20" width="10" height="20" rx="3"/>
    </g>
  </symbol>

  <symbol id="scene-giveway" viewBox="0 0 400 225">
    <rect width="400" height="225" fill="#F0EEEF"/>
    <rect x="0" y="0" width="260" height="225" fill="#2F2A3B"/>
    <g stroke="#fff" stroke-width="6" stroke-dasharray="16 14"><line x1="130" y1="0" x2="130" y2="225"/></g>
    <rect x="260" y="150" width="140" height="60" fill="#2F2A3B"/>
    <polygon points="260,150 310,150 260,165" fill="#fff"/>
    <use href="#sgn-giveway" x="290" y="100" width="40" height="36"/>
  </symbol>

  <symbol id="scene-country" viewBox="0 0 400 225">
    <defs>
      <linearGradient id="g1" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0" stop-color="#CDE7DA"/><stop offset="1" stop-color="#A6D1BD"/>
      </linearGradient>
    </defs>
    <rect width="400" height="225" fill="url(#g1)"/>
    <path d="M0,225 C150,170 250,260 400,180 L400,225 Z" fill="#5BA37C"/>
    <path d="M0,225 C180,110 260,230 400,140 L400,225 Z" fill="#2F2A3B"/>
    <g stroke="#fff" stroke-width="6" stroke-dasharray="16 14">
      <path d="M0,225 C180,110 260,230 400,140"/>
    </g>
  </symbol>

  <symbol id="scene-rain" viewBox="0 0 400 225">
    <rect width="400" height="225" fill="#1D152D"/>
    <rect y="130" width="400" height="95" fill="#2F2A3B"/>
    <g stroke="#9ec" stroke-width="2" opacity=".7">
      <line x1="30" y1="0" x2="10" y2="40"/><line x1="60" y1="0" x2="40" y2="40"/>
      <line x1="90" y1="0" x2="70" y2="40"/><line x1="120" y1="0" x2="100" y2="40"/>
      <line x1="150" y1="0" x2="130" y2="40"/><line x1="180" y1="0" x2="160" y2="40"/>
      <line x1="210" y1="0" x2="190" y2="40"/><line x1="240" y1="0" x2="220" y2="40"/>
      <line x1="270" y1="0" x2="250" y2="40"/><line x1="300" y1="0" x2="280" y2="40"/>
      <line x1="330" y1="0" x2="310" y2="40"/>
    </g>
  </symbol>
</svg>

<script>
/*** SPA nav ***/
const views = {
  home: document.getElementById('view-home'),
  mock: document.getElementById('view-mock'),
  revision: document.getElementById('view-revision'),
  signs: document.getElementById('view-signs')
};
document.querySelectorAll('[data-nav]').forEach(el=>{
  el.addEventListener('click', (e)=>{
    e.preventDefault();
    const v = el.getAttribute('data-nav');
    Object.entries(views).forEach(([k,sec])=> sec.classList.toggle('hidden', k!==v));
    document.querySelectorAll('nav a').forEach(a=> a.removeAttribute('aria-current'));
    const link = document.querySelector(`nav a[data-nav="${v}"]`); if(link) link.setAttribute('aria-current','page');
    if(v==='mock' && !window.MockTest) startMock(); // lazy init
    if(v==='signs') renderSigns();
    if(v==='home') showLastScore();
  });
});

/*** Local storage helpers ***/
const LS = {
  ATTEMPTS: 'ukprep_attempts',
  TOPICS:   'ukprep_topic_accuracy',
  FLAGS:    'ukprep_flags'
};
const getAttempts = ()=> JSON.parse(localStorage.getItem(LS.ATTEMPTS)||'[]');
const saveAttempt  = (a)=> localStorage.setItem(LS.ATTEMPTS, JSON.stringify([a, ...getAttempts()].slice(0,20)));
const getTopicStats= ()=> JSON.parse(localStorage.getItem(LS.TOPICS)||'{}');
const bumpTopic    = (topic, correct)=>{
  const s = getTopicStats(); if(!s[topic]) s[topic]={q:0,c:0}; s[topic].q++; s[topic].c += correct?1:0;
  localStorage.setItem(LS.TOPICS, JSON.stringify(s));
};
const flags = ()=> new Set(JSON.parse(localStorage.getItem(LS.FLAGS)||'[]'));
const toggleFlag = (id)=>{ const f = flags(); f.has(id)?f.delete(id):f.add(id); localStorage.setItem(LS.FLAGS, JSON.stringify([...f])); return f.has(id); };
const clearAll = ()=>{ Object.values(LS).forEach(k=>localStorage.removeItem(k)); location.reload(); };

document.getElementById('btnReset').addEventListener('click', clearAll);
function showLastScore(){
  const el = document.getElementById('lastScore');
  const a = getAttempts()[0];
  el.textContent = a ? `${a.score}/${a.total} on ${new Date(a.date).toLocaleDateString()}` : 'No attempts yet';
}
showLastScore();

/*** Data (DVSA-style but original) ***/
const QUESTIONS = [
  { id:"q1", topic:"Road & Traffic Signs", image:"#sgn-speed30", text:"You see this sign in a built-up area. What does it mean?",
    options:["End of 30 mph limit","National speed limit applies","Maximum speed 30 mph","Minimum speed 30 mph"], answer:2 },
  { id:"q2", topic:"Rules of the Road", image:"#scene-giveway", text:"Approaching this junction, when should you give way?",
    options:["Only if turning right","Only if traffic is on the major road","At all times to traffic on the major road","Only to buses and lorries"], answer:2 },
  { id:"q3", topic:"Alertness", image:"#scene-country", text:"On a narrow country road with high hedges, how should you approach unseen hazards?",
    options:["Use full beam at all times","Sound your horn continuously","Keep a speed that lets you stop in the distance you can see to be clear","Drive in the centre of the road"], answer:2 },
  { id:"q4", topic:"Vulnerable Road Users", image:"#scene-zebra", text:"Pedestrians are waiting at a zebra crossing. What should you do?",
    options:["Wave them across","Continue if your side is clear","Stop and allow them to cross","Sound your horn"], answer:2 },
  { id:"q5", topic:"Incidents & Emergencies", image:"#sgn-works", text:"Road works are ahead and the lane narrows. What should you do?",
    options:["Speed up to clear the area quickly","Stay close to the vehicle in front","Be prepared to give way and merge in turn","Switch on hazard warning lights"], answer:2 },
  { id:"q6", topic:"Documents", image:"#sgn-motorway", text:"You’re travelling on a motorway. Which document must you carry if you tow a small trailer?",
    options:["MOT certificate for the trailer","Insurance certificate for the trailer","Towing isn’t allowed on motorways","No additional documents are normally required"], answer:3 },
  { id:"q7", topic:"Motorway Rules", image:"#sgn-motorway", text:"On a motorway, which lane should you normally use when the road is clear?",
    options:["Left lane","Middle lane","Right lane","Hard shoulder"], answer:0 },
  { id:"q8", topic:"Safety Margins", image:"#scene-rain", text:"It’s raining heavily. What gap should you leave from the vehicle in front?",
    options:["At least 2 seconds","At least 4 seconds","At least 10 car lengths","No extra gap is needed"], answer:1 },
  { id:"q9", topic:"Vehicle Handling", image:"#sgn-roundabout", text:"At a mini-roundabout, you should:",
    options:["Treat it like a normal roundabout and give priority to traffic from the right","Always stop before entering","Give way to traffic from the left","Ignore road markings"], answer:0 },
  { id:"q10", topic:"Other Vehicles", image:"#sgn-horse", text:"You’re following a horse rider on a narrow road. What should you do?",
    options:["Rev your engine to warn them","Overtake immediately","Keep well back and only pass very slowly when safe","Sound your horn"], answer:2 }
];
// signs gallery
const SIGNS = [
  {title:"Maximum speed 30 mph", src:"#sgn-speed30", category:"regulatory", tags:["speed","limit","30"], description:"Circular red-border signs are prohibitions. This sets a 30 mph maximum."},
  {title:"No entry", src:"#sgn-noentry", category:"regulatory", tags:["no entry","one way"], description:"No motor vehicles may enter at this point."},
  {title:"Give way", src:"#sgn-giveway", category:"regulatory", tags:["priority","junction"], description:"Give priority to traffic on the major road."},
  {title:"Road works", src:"#sgn-works", category:"warning", tags:["works","temporary"], description:"Warning triangle indicates road works ahead."},
  {title:"Roundabout", src:"#sgn-roundabout", category:"warning", tags:["junction","roundabout"], description:"Traffic circulates clockwise; give way to your right."},
  {title:"Zebra crossing (scene)", src:"#scene-zebra", category:"scene", tags:["pedestrian","crossing"], description:"Diagram scene: zebra crossing with waiting pedestrians."},
  {title:"Country road bend (scene)", src:"#scene-country", category:"scene", tags:["country","bend"], description:"Narrow country lane with limited forward view."},
  {title:"Give way at junction (scene)", src:"#scene-giveway", category:"scene", tags:["give way","junction"], description:"Side road meeting a major road with ‘give way’ lines."},
  {title:"Motorway sign", src:"#sgn-motorway", category:"informational", tags:["motorway","blue"], description:"Blue rectangular sign indicating motorway route."},
  {title:"Horse warning", src:"#sgn-horse", category:"warning", tags:["horse","animals"], description:"Be ready to slow and give plenty of room to horse riders."}
];

/*** Mock test (balanced random 50, timer, flags, summary) ***/
function startMock(){
  if(window.MockTest) return;
  window.MockTest = true;

  const qText = document.getElementById('qText');
  const optionsBox = document.getElementById('options');
  const mediaBox = document.getElementById('mediaBox');
  const qIndexEl = document.getElementById('qIndex');
  const qTotalEl = document.getElementById('qTotal');
  const bar = document.getElementById('bar');
  const btnPrev = document.getElementById('btnPrev');
  const btnNext = document.getElementById('btnNext');
  const btnFinish = document.getElementById('btnFinish');
  const btnFlag = document.getElementById('btnFlag');
  const timerEl = document.getElementById('timer');
  const summary = document.getElementById('summary');

  // Build 50 (repeat if dataset short)
  const topics = [...new Set(QUESTIONS.map(q=>q.topic))];
  const perTopic = Math.max(1, Math.floor(50/topics.length));
  let pool = [];
  const rnd = (m)=> Math.floor(Math.random()*m);
  const shuffle = arr => { for(let i=arr.length-1;i>0;i--){ const j=rnd(i+1); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; };

  for(const t of topics){
    const subset = QUESTIONS.filter(q=>q.topic===t);
    shuffle(subset);
    pool = pool.concat(subset.slice(0, perTopic));
  }
  while(pool.length < 50) pool.push( QUESTIONS[rnd(QUESTIONS.length)] );
  pool = shuffle(pool).slice(0,50);
  const total = pool.length;
  qTotalEl.textContent = total;

  // State
  let i = 0;
  const answers = new Map();
  let flagged = flags();

  // Timer 57:00
  let remaining = 57*60;
  const t = setInterval(()=>{
    remaining -= 1; if(remaining<0){ clearInterval(t); finish(); return; }
    const m = Math.floor(remaining/60), s = remaining%60;
    if(s===0){ timerEl.parentElement.setAttribute('aria-live','polite'); }
    timerEl.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }, 1000);

  btnPrev.addEventListener('click', ()=>{ if(i>0){ i--; render(); } });
  btnNext.addEventListener('click', ()=>{ if(i<total-1){ i++; render(); } });
  btnFinish.addEventListener('click', finish);
  btnFlag.addEventListener('click', ()=>{ const id = pool[i].id; const on = toggleFlag(id); flagged = flags(); btnFlag.textContent = on?'★ Flagged':'★ Flag'; });

  function render(){
    const q = pool[i];
    qIndexEl.textContent = i+1;
    bar.style.width = `${(i/total)*100}%`;

    // Image (clone symbol)
    mediaBox.innerHTML = '';
    if(q.image){
      const use = document.createElementNS('http://www.w3.org/2000/svg','svg');
      use.setAttribute('viewBox','0 0 400 225'); // default scene box
      if(q.image.includes('sgn-')) use.setAttribute('viewBox','0 0 200 200');
      if(q.image.includes('gives')||q.image.includes('works')||q.image.includes('horse')) use.setAttribute('viewBox','0 0 220 190');
      const u = document.createElementNS('http://www.w3.org/2000/svg','use'); u.setAttributeNS('http://www.w3.org/1999/xlink','href', q.image);
      use.appendChild(u); mediaBox.appendChild(use);
    }

    qText.textContent = q.text;
    optionsBox.innerHTML = '';
    q.options.forEach((opt, idx)=>{
      const id = `opt-${i}-${idx}`;
      const wrap = document.createElement('div'); wrap.className='option';
      wrap.innerHTML = `<input type="radio" id="${id}" name="q-${i}" value="${idx}"><label for="${id}">${opt}</label>`;
      const input = wrap.querySelector('input');
      if(answers.get(q.id)===idx) input.checked = true;
      input.addEventListener('change', ()=>{ answers.set(q.id, idx); if(i===total-1){ btnFinish.classList.remove('hidden'); } });
      optionsBox.appendChild(wrap);
    });

    btnPrev.disabled = i===0;
    btnNext.disabled = i===total-1;
    btnFinish.classList.toggle('hidden', i!==total-1);
    btnFlag.textContent = flagged.has(q.id)?'★ Flagged':'★ Flag';
  }

  function finish(){
    clearInterval(t);
    let score=0; const perTopic={};
    pool.forEach(q=>{
      const picked = answers.get(q.id);
      const ok = picked===q.answer;
      if(ok) score++;
      if(!perTopic[q.topic]) perTopic[q.topic]={q:0,c:0};
      perTopic[q.topic].q++; perTopic[q.topic].c += ok?1:0;
      bumpTopic(q.topic, ok);
    });
    saveAttempt({date: Date.now(), score, total});

    document.querySelector('#view-mock .card').classList.add('hidden');
    summary.classList.remove('hidden');
    const topics = Object.entries(perTopic).map(([t,v])=>`<li><b>${t}</b>: ${v.c}/${v.q} <span class="muted">(${Math.round((v.c/v.q)*100)}%)</span></li>`).join('');
    summary.innerHTML = `
      <h2>Your result: ${score}/${total}</h2>
      <div class="progress" aria-hidden="true"><i style="width:${(score/total)*100}%"></i></div>
      <p>Focus these areas next:</p>
      <ul>${topics}</ul>
      <div class="row"><button class="btn" data-nav="revision">Target weak topics</button><button class="btn ghost" data-nav="mock">Retry</button><button class="btn ghost" data-nav="home">Home</button></div>
    `;
    summary.querySelectorAll('[data-nav]').forEach(b=> b.addEventListener('click',e=>{ e.preventDefault(); document.querySelector(`[data-nav="${b.getAttribute('data-nav')}"]`).click(); }));
    window.scrollTo({top:0, behavior:'smooth'});
  }

  render();
}

/*** Revision mini-drills ***/
const revRoot = document.getElementById('revRoot');
document.getElementById('btnWeak').addEventListener('click', ()=>{
  revRoot.innerHTML = '';
  const stats = getTopicStats();
  const sorted = Object.entries(stats).sort((a,b)=> (a[1].c/a[1].q) - (b[1].c/b[1].q));
  const top3 = sorted.slice(0,3).map(([t])=>t);
  const list = QUESTIONS.filter(q=> top3.includes(q.topic)).slice(0,10);
  buildRevCard('10 from your weak topics', list);
});
document.getElementById('btnAll').addEventListener('click', ()=>{
  revRoot.innerHTML = '';
  const pick = [...QUESTIONS].sort(()=>Math.random()-.5).slice(0,10);
  buildRevCard('10 random', pick);
});
function buildRevCard(title, list){
  const card = document.createElement('div'); card.className='card';
  card.innerHTML = `<h3>${title}</h3>`;
  const ul = document.createElement('ul');
  list.forEach(q=>{
    const li = document.createElement('li');
    li.innerHTML = `<button class="btn ghost small" style="padding:8px 10px">Practice</button> ${q.text}`;
    ul.appendChild(li);
  });
  card.appendChild(ul);
  revRoot.appendChild(card);
}

/*** Signs gallery ***/
const signGrid = document.getElementById('signGrid');
const search = document.getElementById('search');
const filter = document.getElementById('filter');
function renderSigns(){
  const term = (search.value||'').toLowerCase();
  const cat = filter.value;
  signGrid.innerHTML = '';
  SIGNS.filter(s=> (cat==='all'||s.category===cat) && (s.title.toLowerCase().includes(term)||s.tags.some(t=>t.includes(term)))).forEach(item=>{
    const card = document.createElement('div'); card.className='card reveal';
    const figure = document.createElementNS('http://www.w3.org/2000/svg','svg');
    // default viewboxes (sign vs scene)
    figure.setAttribute('viewBox', item.src.includes('scene-') ? '0 0 400 225' : (item.src.includes('giveway')||item.src.includes('works')||item.src.includes('horse')) ? '0 0 220 190' : '0 0 200 200');
    const use = document.createElementNS('http://www.w3.org/2000/svg','use'); use.setAttributeNS('http://www.w3.org/1999/xlink','href', item.src);
    const media = document.createElement('div'); media.className='media'; media.appendChild(figure); figure.appendChild(use);
    card.appendChild(media);
    const h4 = document.createElement('h4'); h4.textContent = item.title; card.appendChild(h4);
    const p = document.createElement('p'); p.className='small muted'; p.textContent = item.description; card.appendChild(p);
    signGrid.appendChild(card);
  });
}
search.addEventListener('input', renderSigns);
filter.addEventListener('change', renderSigns);
</script>
</body>
</html>
